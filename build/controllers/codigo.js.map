{"version":3,"sources":["../../app/controllers/codigo.js"],"names":["validationOptions","recursive","abortEarly","stripUnknown","solicitarCodigo","stub","args","t0","performance","now","data","codigoPutStatePromises","JSON","parse","toString","err","Error","console","info","embarcador","quantidade","embarcadorSelected","toLowerCase","embarcadorAvailable","includes","organizationMSPID","getCreator","mspid","batch","docType","id","codigos","organization","i","codigo","newCodigo","batchId","transportador","rota","servico","servico_codigo","usado","newCodigoAsBytes","getState","push","putState","Buffer","from","stringify","Promise","all","batchAsBytes","setEvent","log","t1","usarCodigo","formattedData","usarCodigoSchema","validate","e","message","dataAsBytes","undefined","dataToUpdate","updatedData","updatedDataAsBytes"],"mappings":"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","file":"codigo.js","sourcesContent":["// const config = require('../config.js');\nimport uuidv4 from 'uuid/v4';\nimport { performance } from 'perf_hooks';\nimport { generateCodigo } from '../utils';\nimport { usarCodigoSchema } from '../models/codigo';\n//  descend into nested schema - return on first error - remove unspecified keys from objects\nconst validationOptions = { recursive: true, abortEarly: true, stripUnknown: true };\n\nexport const solicitarCodigo = async (stub, args) => {\n  const t0 = performance.now();\n\n  let data;\n  const codigoPutStatePromises = [];\n\n  // Parse JSON stringified request\n  try {\n    data = JSON.parse(args.toString());\n  } catch (err) {\n    throw new Error('Não foi possivel decodificar o JSON, por favor verifique o formato');\n  }\n  console.info('--- start solicitarCodigo ---');\n\n  // check mandatory fields\n  if (!(data.embarcador && data.quantidade)) {\n    throw new Error('Por favor preenche campo mandatorio');\n  }\n  // Verify embarcador value\n  const embarcadorSelected = data.embarcador.toLowerCase();\n  const embarcadorAvailable = ['b2w', 'mercado livre', 'magazine luiza', 'via varejo', 'privalia'];\n  if (!embarcadorAvailable.includes(embarcadorSelected)) {\n    throw new Error('Embarcador nao disponivel');\n  }\n\n  const organizationMSPID = stub.getCreator().mspid;\n\n  // Create batch\n  const batch = {\n    docType: 'batch',\n    embarcador: embarcadorSelected,\n    id: uuidv4(),\n    codigos: [],\n    organization: organizationMSPID\n  };\n\n  // Create tracking code\n  for (let i = 0; i < data.quantidade; i += 1) {\n    let codigo;\n    let newCodigo = true;\n    while (newCodigo) {\n      codigo = {\n        batchId: batch.id,\n        docType: 'codigo',\n        id: generateCodigo(),\n        transportador: '',\n        embarcador: embarcadorSelected,\n        rota: '',\n        servico: '',\n        servico_codigo: '',\n        usado: false\n        // status: 1\n      };\n\n      // verify if codigo already exist\n      /* eslint no-await-in-loop: \"off\" */\n      const newCodigoAsBytes = await stub.getState(codigo.id);\n      // Generate a new code if codigo already exist\n      /* eslint no-unneeded-ternary: \"off\" */\n      newCodigo = newCodigoAsBytes.toString() ? true : false;\n    }\n    // Push to batch\n    batch.codigos.push(codigo.id);\n\n    // Put codigo to ledger\n    codigoPutStatePromises.push(stub.putState(codigo.id, Buffer.from(JSON.stringify(codigo))));\n  }\n\n  // Wait for all codigo putState promise\n  await Promise.all(codigoPutStatePromises);\n\n  // Put batch to ledger\n  const batchAsBytes = Buffer.from(JSON.stringify(batch));\n  await stub.putState(batch.id, batchAsBytes);\n\n  stub.setEvent('batchCreated', batchAsBytes);\n  console.info('==================');\n  console.log(batch);\n  console.info('==================');\n\n  console.info('--- end create codigoRastreamento ---');\n\n  const t1 = performance.now();\n  console.log(`Call took ${t1 - t0} ms.`);\n};\n\nexport const usarCodigo = async (stub, args) => {\n  let data;\n  let formattedData;\n\n  // Parse JSON stringified request\n  try {\n    data = JSON.parse(args.toString());\n  } catch (err) {\n    throw new Error('Não foi possivel decodificar o JSON, por favor verifique o formato');\n  }\n\n  console.info('--- start usoCodigo ---');\n\n  // check mandatory fields\n  if (!data.id) {\n    throw new Error('Por favor fornece um campo \"id\"');\n  }\n\n  // Verify data format\n  try {\n    formattedData = await usarCodigoSchema.validate(data, validationOptions);\n  } catch (e) {\n    console.log(e);\n    throw new Error(e.message);\n  }\n\n  // Verify if data exists\n  const dataAsBytes = await stub.getState(data.id);\n  if (dataAsBytes === undefined || !dataAsBytes.toString()) {\n    throw new Error(`codigo \"${data.id}\" nao encontrado`);\n  }\n\n  // Parse data that will be updated\n  const dataToUpdate = JSON.parse(dataAsBytes.toString());\n  // Verify if not used\n  if (dataToUpdate.usado) {\n    throw new Error(`codigo \"${data.id}\" ja usado`);\n  }\n\n  // Merge formatted data\n  const updatedData = { ...dataToUpdate, ...formattedData };\n\n  // 8. Put unidadeTransporte in the Ledger & send event\n  const updatedDataAsBytes = Buffer.from(JSON.stringify(updatedData));\n  await stub.putState(updatedData.id, updatedDataAsBytes);\n\n  stub.setEvent('codigoUsado', updatedDataAsBytes);\n  console.info('==================');\n  console.log(updatedData);\n  console.info('==================');\n  console.info('--- usoCodigo ---');\n};\n\n// POST /uso-codigo/BR9380921SW\n\n// {\n//   \"transportador\":62,\n//   \"embarcador\":1,\n//   \"rota\": \"BLU-BRS\",\n//   \"servico\": \"SEDEX\",\n//   \"servico_code\": \"81983\",\n//   \"usado\": \"2019-12-12 12:12:00\"\n// }\n\n// DIGITS => Formato\n// 1-2 => [AZ] (aleatorio)\n// 3-10 => [0-9] (aleatorio)\n// 11 => [0-9] (check Digit)\n// 12-13 => [AZ] (aleatorio - menos \"BR\")\n\n// GET /codigos_rastreamento/12\n\n// ATIVO\n\n// status: 1 => criado\n// status: 2 => usado\n// status: 3 => Expirado\n// status: 4 => Arquivado\n\n// Front da Demo do código de Rastreamento:\n\n// [Overview]\n// Igual no demo hoje\n\n// [Gerar Código]\n// - Dropdown de \"Embarcador\" com 5 opções: B2W, Mercado Livre, Magazine Luiza, Via Varejo, Privalia\"\n// - Input de \"Quantidade\"\n\n// Resultado\n// - lista de Códigos gerados\n\n// [Usar Codigo]\n// - Dropdown dos Embarcadores (Mercado livre, etc)\n\n// Depois a seleção apararece  uma lista de Códigos disponíveis\n\n// Pode clicar em um código e preencher as informações necessários e gravar.\n\n// ------------------\n// quick obervacao, quando a gente cria codigo tem dois jeito pra fazer\n\n// 1. criar um codigo sem verificacao (por 20 codigo 9.39695700071752 ms)\n// 2. criar um codigo é verifica se exist na blockchain (por 3 codigos 71.542519999668 ms)\n\n// let codeGenerated;\n// let existingCode = true;\n// while (existingCode) {\n//   codeGenerated = generateCode();\n//   // Verify if code exist after generating\n//   /* eslint no-await-in-loop: \"off\" */\n//   const codeGeneratedAsBytes = await stub.getState(codeGenerated);\n//   /* eslint no-unneeded-ternary: \"off\" */\n//   existingCode = codeGeneratedAsBytes.toString() ? true : false; // loop until does not exist\n// }\n\n// Solucao 1:\n// Criar um batch de codigo com um idBatch, codigo nao cadastrado na blockchain, cadastrado quando usa uso-codigo\n// vantagem: Podemos verificar se o codigo existe na funcao uso-codigo (por 20 codigo 9.39695700071752 ms)\n// {\n//   idBatch: 1,\n//   \"codigos\": [\n//     \"BR9380921SW\",\n//     \"BR838838SW\",\n//     \"BR9380921SWs\",\n//   ],\n//   \"quantidade\": 3,\n//   \"criado\": \"2018-12-12 12:12:00\"\n// }\n\n// Solucao 2:\n// Criar cada codigo e cadastra na blockchain é mandar formato tipo encima (com status criado)\n// desvantagem: precisa ver se a cada se ja é cadastrado (71.542519999668 ms por 20 codigo)\n// {\n//   \"id\": \"BR9380921SW\"\n//   \"organization\":1,\n//   \"rota\": \"BLU-BRS\",\n//   \"servico\": \"SEDEX\",\n//   \"servico_code\": \"81983\",\n//   \"usado\": \"2019-12-12 12:12:00\"\n//   \"status\": 2\n// }\n"]}