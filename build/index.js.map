{"version":3,"sources":["../app/index.js"],"names":["Codigo","Chaincode","stub","ret","getFunctionAndParameters","console","info","shim","success","getTxID","util","format","getArgs","method","fcn","message","log","error","payload","params","err","args","data","Error","dataAsBytes","getState","toString","solicitarCodigo","e","usarCodigo","length","queryString","getQueryResultForQueryString","queryResults","resultsIterator","getQueryResult","getAllResults","results","Buffer","from","JSON","stringify","id","getHistoryForKey","iterator","isHistory","allResults","res","next","value","jsonResponse","TxId","tx_id","Timestamp","timestamp","IsDelete","is_delete","Value","parse","Key","key","Record","push","done","close","start"],"mappings":"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","file":"index.js","sourcesContent":["/*\n# Copyright IBM Corp. All Rights Reserved.\n#\n# SPDX-License-Identifier: Apache-2.0\n*/\nimport shim from 'fabric-shim';\nimport util from 'util';\nimport * as Codigo from './controllers/codigo';\n\nexport default class Chaincode {\n  async Init(stub) {\n    const ret = stub.getFunctionAndParameters();\n    console.info(ret);\n    console.info('=========== Instantiated Logistic Chaincode ===========');\n    return shim.success();\n  }\n\n  async Invoke(stub) {\n    console.info('########################################');\n    console.info(`Transaction ID: ${stub.getTxID()}`);\n    console.info(util.format('Args: %j', stub.getArgs()));\n\n    const ret = stub.getFunctionAndParameters();\n    console.info(ret);\n\n    const method = this[ret.fcn];\n    if (!method) {\n      const message = `funcao com nome ${ret.fcn} nao encontrado`;\n      console.log(message);\n      return shim.error(message);\n    }\n    try {\n      const payload = await method(stub, ret.params);\n      return shim.success(payload);\n    } catch (err) {\n      console.log(err);\n      return shim.error(err.message ? err.message : err);\n    }\n  }\n\n  async getDataById(stub, args) {\n    // 1. Verify batchId is not empty\n    const data = args[0];\n    if (!data) {\n      throw new Error('Por favor especifique um id');\n    }\n\n    console.info('--- start getData ---');\n\n    // 2. Verify if batch exist\n    const dataAsBytes = await stub.getState(data);\n    if (!dataAsBytes.toString()) {\n      throw new Error(`\"Data com id ${data} nao encontrado\"`);\n    }\n\n    console.info('==================');\n    console.log(dataAsBytes.toString());\n    console.info('==================');\n    console.info('--- end getData ---');\n\n    return dataAsBytes;\n  }\n\n  async solicitarCodigo(stub, args) {\n    try {\n      await Codigo.solicitarCodigo(stub, args);\n    } catch (e) {\n      throw e;\n    }\n  }\n\n  async usarCodigo(stub, args) {\n    try {\n      await Codigo.usarCodigo(stub, args);\n    } catch (e) {\n      throw e;\n    }\n  }\n\n  // Rich Query (Only supported if CouchDB is used as state database):\n  // peer chaincode query -C myc -n mycc -c\n  // '{\"Args\":[\"richQuery\",\"{\\\"selector\\\":{\\\"status\\\":\\\"1\\\"}}\"]}'\n  async richQuery(stub, args) {\n    //   0\n    // 'queryString'\n    if (args.length < 1) {\n      throw new Error('Incorrect number of arguments. Expecting queryString');\n    }\n    const queryString = args[0];\n    if (!queryString) {\n      throw new Error('queryString must not be empty');\n    }\n    const method = this.getQueryResultForQueryString;\n    const queryResults = await method(stub, queryString);\n    return queryResults;\n  }\n\n  static async getAllResults(iterator, isHistory) {\n    const allResults = [];\n    while (true) {\n      /* eslint no-await-in-loop: \"off\" */\n      const res = await iterator.next();\n\n      if (res.value && res.value.value.toString()) {\n        const jsonResponse = {};\n        // console.log(res.value.value.toString(\"utf8\"));\n\n        if (isHistory && isHistory === true) {\n          jsonResponse.TxId = res.value.tx_id;\n          jsonResponse.Timestamp = res.value.timestamp;\n          jsonResponse.IsDelete = res.value.is_delete.toString();\n          try {\n            jsonResponse.Value = JSON.parse(res.value.value.toString('utf8'));\n          } catch (err) {\n            console.log(err);\n            jsonResponse.Value = res.value.value.toString('utf8');\n          }\n        } else {\n          jsonResponse.Key = res.value.key;\n          try {\n            jsonResponse.Record = JSON.parse(res.value.value.toString('utf8'));\n          } catch (err) {\n            console.log(err);\n            jsonResponse.Record = res.value.value.toString('utf8');\n          }\n        }\n        allResults.push(jsonResponse);\n      }\n      if (res.done) {\n        console.log('end of data');\n        await iterator.close();\n        console.info(JSON.stringify(allResults));\n        return allResults;\n      }\n    }\n  }\n\n  // getQueryResultForQueryString executes the passed in query string.\n  // Result set is built and returned as a byte array containing the JSON results.\n  async getQueryResultForQueryString(stub, queryString) {\n    console.info(`- getQueryResultForQueryString queryString:\\n + ${queryString}`);\n    const resultsIterator = await stub.getQueryResult(queryString);\n    const method = this.getAllResults;\n\n    const results = await method(resultsIterator, false);\n\n    return Buffer.from(JSON.stringify(results));\n  }\n\n  async getHistory(stub, args) {\n    if (args.length < 1) {\n      throw new Error('Incorrect number of arguments. Expecting an id to look for');\n    }\n    const id = args[0];\n    console.info('--- start getHistoryFor: %s\\n');\n\n    const resultsIterator = await stub.getHistoryForKey(id);\n    const method = this.getAllResults;\n    const results = await method(resultsIterator, true);\n\n    return Buffer.from(JSON.stringify(results));\n  }\n}\n\nshim.start(new Chaincode());\n"]}